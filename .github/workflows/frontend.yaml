name: Deployment Pipeline Angular
on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      tags:
        description: Tag
        required: true 
        type: string
jobs:
  tagging:
    name: Getting the Tag
    runs-on: ubuntu-20.04
    outputs:
      TAG: ${{ steps.tag.outputs.TAG }}
    steps:
      - name: Getting the Tag
        id: tag
        run: |
          TAG=$(git describe ${{ github.sha }})
          if [ ${{ github.event_name }} == 'workflow_dispatch' ]; then
            echo "TAG=${{ github.event.inputs.tags }}" >> $GITHUB_OUTPUT
          elif [ ${{ github.event_name }} == 'push' ] && [  TAG=~ "v-" ]; then
            echo "TAG=$TAG" >> $GITHUB_OUTPUT
          else
            echo "Tagging Failed"
            exit 1  
          fi

  build:
    name: Build Angular Application
    needs: [tagging]
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Getting Enviromnet Variables
        run: |
          echo ${{ needs.tagging.outputs.TAG}}
      - name: Starting Angular Application Building
        uses: ./.github/actions/frontend/build-angular
  
  deploy-dev:
    name: Deploy to dev
    needs: [build]
    environment:
      name: dev
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Starting Angular Application Building
        uses: ./.github/actions/frontend/deploy
        with:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} 
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

  deploy-test:
    name: Deploy to test
    needs: [build, deploy-dev]
    environment:
      name: test
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Starting Angular Application Building
        uses: ./.github/actions/frontend/deploy
        with:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} 
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}